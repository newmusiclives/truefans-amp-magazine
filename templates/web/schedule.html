{% extends "base.html" %}
{% block title %}Schedule — WEEKLYAMP{% endblock %}
{% block nav_schedule %}active{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Send Schedule</h2>
    <p>Configure multi-frequency publishing — which days and which sections</p>
</div>

<!-- Add/edit send day -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Configure Send Day</span>
    </div>
    <form hx-post="/schedule/save-day" hx-target="#schedule-table" hx-swap="outerHTML">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
            <div class="form-group">
                <label>Day of Week</label>
                <select name="day_of_week">
                    {% for d in days %}
                    <option value="{{ d }}">{{ d | title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Label</label>
                <input type="text" name="label" placeholder="e.g. Main Issue">
            </div>
        </div>
        <div class="form-group">
            <label>Sections</label>
            <div class="section-picker">
                {% set cats = {} %}
                {% for s in sections %}
                    {% set cat = s.category or 'uncategorized' %}
                    {% if cat not in cats %}
                        {% if cats.update({cat: []}) %}{% endif %}
                    {% endif %}
                    {% if cats[cat].append(s) %}{% endif %}
                {% endfor %}
                {% for cat, cat_sections in cats.items() %}
                <div class="section-category-group">
                    <div class="section-category-label">{{ cat | replace('_', ' ') | title }}</div>
                    <div class="section-checkboxes">
                        {% for s in cat_sections %}
                        <label class="checkbox-label">
                            <input type="checkbox" name="section_slugs" value="{{ s.slug }}">
                            {{ s.display_name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top:8px">Save Day</button>
    </form>
</div>

<!-- Schedule table + upcoming -->
<div id="schedule-table">
    {% include "partials/schedule_table.html" %}
</div>

<!-- Create week issues + auto-plan -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Create Week Issues</span>
    </div>
    <div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap">
        <form hx-post="/schedule/create-week-issues" hx-target="#schedule-table" hx-swap="outerHTML"
              style="display:flex;gap:12px;align-items:end">
            <div class="form-group">
                <label>Week ID (leave blank for current week)</label>
                <input type="text" name="week_id" placeholder="2026-W07" style="width:200px">
            </div>
            <button type="submit" class="btn btn-primary" style="margin-bottom:16px">Create Issues</button>
        </form>
        <form hx-post="/schedule/auto-plan-week" hx-target="#schedule-table" hx-swap="outerHTML"
              style="display:flex;align-items:end">
            <button type="submit" class="btn btn-primary" style="margin-bottom:16px"
                    title="Fill in missing category coverage across all send days">Auto-Plan Categories</button>
        </form>
    </div>
</div>

<style>
.section-picker {
    display:flex;flex-wrap:wrap;gap:16px;
}
.section-category-group {
    flex:1 1 200px;min-width:180px;
    border:1px solid var(--border);border-radius:6px;padding:10px;
}
.section-category-label {
    font-weight:600;font-size:12px;text-transform:uppercase;
    letter-spacing:0.5px;color:var(--primary);margin-bottom:6px;
}
.section-checkboxes {
    display:flex;flex-direction:column;gap:4px;
}
.checkbox-label {
    display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer;
}
.checkbox-label input[type="checkbox"] {
    margin:0;
}
</style>
{% endblock %}
